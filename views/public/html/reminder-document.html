<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link rel="icon" type="image/x-icon" href="./fav-icon.ico" />

    <title>Renewal Reminder | Nsnemo</title>

    <meta name="description" content="" />

    <style>
      .loader {
        --r1: 154%;
        --r2: 68.5%;
        width: 60px;
        aspect-ratio: 1;
        border-radius: 50%;
        background: radial-gradient(
            var(--r1) var(--r2) at top,
            #0000 79.5%,
            #269af2 80%
          ),
          radial-gradient(
            var(--r1) var(--r2) at bottom,
            #269af2 79.5%,
            #0000 80%
          ),
          radial-gradient(var(--r1) var(--r2) at top, #0000 79.5%, #269af2 80%),
          #ccc;
        background-size: 50.5% 220%;
        background-position: -100% 0%, 0% 0%, 100% 0%;
        background-repeat: no-repeat;
        animation: l9 1.4s linear forwards;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
      }

      @keyframes l9 {
        33% {
          background-position: 0% 33%, 100% 33%, 200% 33%;
        }
        66% {
          background-position: -100% 66%, 0% 66%, 100% 66%;
        }
        100% {
          background-position: 0% 100%, 100% 100%, 200% 100%;
        }
      }
    </style>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
      rel="stylesheet"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Company - Nsnemo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link
      rel="stylesheet"
      href="../assets/vendor/css/core.css"
      class="template-customizer-core-css"
    />
    <link
      rel="stylesheet"
      href="../assets/vendor/css/theme-default.css"
      class="template-customizer-theme-css"
    />
    <link rel="stylesheet" href="../assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link
      rel="stylesheet"
      href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css"
    />

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="../assets/vendor/js/helpers.js"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="../assets/js/config.js"></script>
  </head>

  <body>
    <div id="logoutContent"></div>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->

        <aside
          id="layout-menu"
          class="layout-menu menu-vertical menu bg-menu-theme"
        >
          <div
            class="app-brand demo mt-0"
            style="
              background-color: #008e9c;
              padding-top: 70px;
              padding-bottom: 50px;
            "
            id="leftLogo"
          ></div>

          <ul class="menu-inner py-1 pt-3" id="menuList"></ul>
        </aside>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->

          <nav
            class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme"
            id="layout-navbar"
          ></nav>

          <!-- / Navbar -->

          <!-- Content wrapper -->

          <div class="container-fluid">
            <!-- <a href='./indexpage.html' class="btn btn-primary  mt-3" >  Back to Dashboard</a> -->

            <div class="p-3 card mt-3">
              <h4>Documents with Approaching Expiry Dates</h4>
              <div id="loader" class="text-center" style="display: none">
                Loading...
              </div>
              <div
                id="error"
                class="text-center text-danger"
                style="display: none"
              >
                Error: Failed to fetch expiry dates.
              </div>

              <form id="submitButton" class="d-flex justify-content-start">
                <input type="date" id="dateInput" class="form-control w-25" />
                <button type="submit" class="btn btn-primary ms-3">
                  Filter Expiry Date
                </button>
              </form>
              <h4
                class="text-center mt-3 mb-0 rounded-0 shadow-none border border-dark card p-3"
              >
                Documents List
              </h4>
              <table
                id="documentsTable"
                class="table table-bordered table-striped table-responsive table-sm text-center"
              >
                <thead>
                  <tr>
                    <th>Candidate Id</th>
                    <th>Document</th>
                    <th>Document Number</th>
                    <th>Issue Date</th>
                    <th>Expiry Date</th>
                    <th>Issue Place</th>
                    <th>STCW</th>
                    <th>Status</th>
                    <!-- New column for status -->
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Footer -->
          <footer
            class="footer mt-auto py-3 bg-footer-theme"
            id="footetcontent"
          ></footer>
          <div class="content-wrapper" style="display: none">
            <!-- Content -->
          </div>
        </div>

        <!-- /Account -->
        <!-- / Content -->

        <!-- / Footer -->

        <div class="content-backdrop fade"></div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>
    </div>
    <!-- / Layout wrapper -->

    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="../assets/vendor/libs/jquery/jquery.js"></script>
    <script src="../assets/vendor/libs/popper/popper.js"></script>
    <script src="../assets/vendor/js/bootstrap.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>

    <script src="../assets/vendor/js/menu.js"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script>
      let activeMenu = "dashboard";
      let activesub = "dashboard";
      let currentPage = "Renewal Reminder";
    </script>
    <script src="./menu.js"></script>
    <script src="../assets/js/helper.js"></script>

    <!-- Main JS -->
    <script src="../assets/js/main.js"></script>
    <!-- Page JS -->
    <script src="../assets/js/pages-account-settings-account.js"></script>

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loader = document.getElementById("loader");
        const error = document.getElementById("error");
        const documentsTable = document
          .getElementById("documentsTable")
          .getElementsByTagName("tbody")[0];
        const dateInput = document.getElementById("dateInput");
        const submitButton = document.getElementById("submitButton");

        // Fetch data when the page loads
        // fetchData();

        submitButton.addEventListener("submit", function (e) {
          e.preventDefault();
          showLoader('documentsTable')
          const selectedDate = dateInput.value;
          fetchData(selectedDate);
        });

        function fetchData(selectedDate) {
          loader.style.display = "block";
          error.style.display = "none";

          let url = `${config.APIURL}candidate/expiry-date`;
          let requestData = {}; // Initialize request data object
          hideLoader('documentsTable')
          if (selectedDate) {
            // If selectedDate is provided, add it to requestData object
            requestData = {
              date: selectedDate,
            };
          }

          const token = localStorage.getItem("token");
          const user = decodeToken(token);
          const userId = user.userId;
          const candidateId = localStorage.getItem("memId");

          // Append both userId and candidateId as query parameters to the URL
          url += `/${userId}`;

          axios
            .get(url, {
              params: requestData, // Pass requestData as params to GET request
              headers: {
                Authorization: token,
              },
            })
            .then((response) => {
              console.log(response);
              renderData(response.data);
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
              showError();
            })
            .finally(() => {
              loader.style.display = "none";
            });
        }

        function renderData(documents) {
          const tableBody = documentsTable;
          tableBody.innerHTML = "";

          // Check if documents is an array
          if (!Array.isArray(documents)) {
            showError(); // Show error message
            return; // Exit the function
          }

          documents.forEach((document) => {
            const expiryDate = new Date(document.expiry_date);
            const currentDate = new Date();
            const timeDifference = expiryDate.getTime() - currentDate.getTime();
            const daysDifference = Math.ceil(
              timeDifference / (1000 * 3600 * 24)
            );

            let status;
            let badgeClass;
            let badgeText;

            if (expiryDate < currentDate) {
              status = "Expired";
              badgeClass = "badge btn-danger";
              badgeText = "Expired";
            } else if (
              expiryDate.toDateString() == currentDate.toDateString()
            ) {
              status = "Expiring Today";
              badgeClass = "badge btn-warning";
              badgeText = "Expiring Today";
            } else {
              status = `Expiring in ${daysDifference} days`;
              badgeClass = "badge btn-warning";
              badgeText = `Expiring in ${daysDifference} days`;
            }

            const row = `
                   <tr>
                     <td><button class='btn text-primary' onclick=viewCandidate(${
                       document.candidateId
                     })>${document.candidateId}</button></td>
                       <td>${document.document}</td>
                       <td>${document.document_number}</td>
                       <td>${formatDate(document.issue_date)}</td>
                       <td>${formatDate(expiryDate)}</td>
                       <td>${document.issue_place}</td>
                       <td>${document.stcw}</td>
                       <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                   </tr>
               `;
            tableBody.insertAdjacentHTML("beforeend", row);
          });
        }

        function formatDate(date) {
          const formattedDate = new Date(date);
          return formattedDate.toLocaleDateString(); // Adjust the format as needed
        }

        function showError() {
          error.style.display = "block";
        }
      });

      function viewCandidate(candidateId) {
        // Construct the URL with query parameter
        let url = "./view-candidate.html?id=" + candidateId;

        // Open the URL in a new tab/window
        window.open(url, "_blank");
      }
    </script>
  </body>
</html>
