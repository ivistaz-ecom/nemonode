<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidates</title>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="../assets/vendor/fonts/boxicons.css" />
    <link rel="stylesheet" href="../assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="../assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="../assets/css/demo.css" />
</head>
<body class="p-5">
    <h2>Available Candidates - Overall</h2>
    <a href="./indexpage.html" class="float-end me-5 text-decoration-none mt-3"> >> Back to Dashboard</a>
    
    <div class="border p-5 pt-4 pb-2">
        <h5 class="text-primary">Candidates : Rank</h5> - click the buttons to filter candidates based on rank

    <!-- List group for rank names and counts -->
    <div class="list-group p-5 " id="rankListGroup">
        <!-- Rank names and counts will be dynamically added here -->
    </div>

    </div>
    <button id="exportExcelBtn" class="btn text-dark border m-2 float-end">Export to Excel</button>

    <table class="table table-bordered bg-white">
        <thead>
            <tr>
                <th>Name</th>
                <th>Rank</th>
                <th>Available Date</th>
                <th>Status</th>
                <th>Actions</th> <!-- New column for actions -->
            </tr>
        </thead>
        <tbody id="candidatesTableBody">
            <!-- Table rows will be dynamically added here -->
        </tbody>
    </table>
    <script>
        // Function to fetch candidate data and populate the table
  // Function to fetch candidate data and populate the table
// Function to fetch candidate data and populate the table
async function populateCandidatesTable() {
    try {
        const token = localStorage.getItem('token');
        const response = await axios.get('https://nemonode.ivistaz.co/candidate/view-candidate', {
            headers: { "Authorization": token }
        });
        const responseData = response.data;
        let candidates = responseData.candidates; // Accessing the candidates array
        
        // Filter out candidates who are not available
        candidates = candidates.filter(candidate => getStatus(candidate.avb_date) !== "Not available");
        
        // Sort candidates based on availability status
        candidates.sort((a, b) => getStatusOrder(a.avb_date) - getStatusOrder(b.avb_date));
        
        const tableBody = document.getElementById('candidatesTableBody');
        tableBody.innerHTML = ''; // Clear previous data
        
        candidates.forEach(candidate => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${candidate.fname}</td>
                <td>${candidate.c_rank}</td>
                <td>${candidate.avb_date}</td>
                <td><span class="badge ${getStatusBadgeClass(candidate.avb_date)}">${getStatus(candidate.avb_date)}</span></td>
                <td><button class="btn btn-primary" onclick="handleView('${candidate.id}')">View</button></td> <!-- View button -->
            `;
            tableBody.appendChild(row);
        });

        populateRankListGroup(candidates); // Populate rank list group

    } catch (error) {
        console.error(error);
    }
}

// Function to handle the "View" button click
function handleView(id) {
    alert(`View button clicked for candidateId ${id}`);
    // Add your view logic here
    localStorage.setItem('memId', id);
    window.location.href = './view-candidate.html';
}


        // Function to populate list group with rank names and counts
       // Function to populate list group with rank names and counts of available candidates
// Function to populate list group with rank names and counts of available candidates
function populateRankListGroup(candidates) {
    const ranksData = {};
    candidates.forEach(candidate => {
        if (getStatus(candidate.avb_date) !== "Not available") {
            ranksData[candidate.c_rank] = ranksData[candidate.c_rank] ? ranksData[candidate.c_rank] + 1 : 1;
        }
    });

    const rankListGroup = document.getElementById('rankListGroup');
    rankListGroup.innerHTML = ''; // Clear existing data

    for (const rank in ranksData) {
        const button = document.createElement('button');
        button.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center', 'btn', 'btn-primary');
        button.innerHTML = `${rank} : ${ranksData[rank]}`;
        button.addEventListener('click', () => filterCandidatesByRank(rank, candidates));
        button.style.textAlign = 'left'; // Align button text to the left
        button.style.width = '100%'; // Make button width 100%
        button.style.marginBottom = '5px'; // Add some margin to separate buttons
        rankListGroup.appendChild(button);
    }
}

        // Function to filter candidates by rank
        function filterCandidatesByRank(rank, candidates) {
            const filteredCandidates = candidates.filter(candidate => candidate.c_rank === rank);
            const tableBody = document.getElementById('candidatesTableBody');
            tableBody.innerHTML = ''; // Clear previous data
            filteredCandidates.forEach(candidate => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${candidate.fname}</td>
                    <td>${candidate.c_rank}</td>
                    <td>${candidate.avb_date}</td>
                    <td><span class="badge ${getStatusBadgeClass(candidate.avb_date)}">${getStatus(candidate.avb_date)}</span></td>
                    <td><button class="btn btn-primary" onclick="handleView('${candidate.id}')">View</button></td> <!-- View button -->
                `;
                tableBody.appendChild(row);
            });
        }

        // Function to determine the status order
        function getStatusOrder(avb_date) {
            const today = new Date();
            const avbDate = new Date(avb_date);
            const diffTime = avbDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Convert milliseconds to days
            if (diffDays === 0) {
                return 1; // Available
            } else if (diffDays < 0) {
                return 3; // Not available
            } else {
                return 2; // Available in __ days
            }
        }

        // Function to determine the status based on avb_date
        function getStatus(avb_date) {
            const today = new Date();
            const avbDate = new Date(avb_date);
            const diffTime = avbDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Convert milliseconds to days
            if (diffDays === 0) {
                return "Available";
            } else if (diffDays < 0) {
                return "Not available";
            } else {
                return `Available in ${diffDays} days`;
            }
        }

        // Function to determine the Bootstrap badge class based on avb_date
        function getStatusBadgeClass(avb_date) {
            const today = new Date();
            const avbDate = new Date(avb_date);
            const diffTime = avbDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Convert milliseconds to days
            if (diffDays === 0) {
                return "bg-success";
            } else if (diffDays < 0) {
                return "bg-danger";
            } else {
                return "bg-primary";
            }
        }

        // Call the function to populate the table when the page loads
        populateCandidatesTable();

        const exportExcelBtn = document.getElementById('exportExcelBtn');

exportExcelBtn.addEventListener('click', function () {
    exportCandidatesToExcel();
});

function exportCandidatesToExcel() {
    const table = document.getElementById('candidatesTableBody');
    const wb = XLSX.utils.table_to_book(table, { sheet: "Candidates" });
    XLSX.writeFile(wb, 'candidates.xlsx');
}

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>

</body>
</html>
